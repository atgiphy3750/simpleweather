<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
		<title>ÎÇ†Ïî®</title>
		<link rel="preconnect" href="https://fonts.gstatic.com" />
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='index.css') }}"
		/>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='common.css') }}"
		/>
		<link rel="preconnect" href="https://fonts.gstatic.com" />
	</head>
	<body>
		<div class="flex flex-column center app">
			<div class="flex flex-row center cards"></div>
		</div>
	</body>
	<script>
		var url = 'data';
		window.onload = function () {
			show();
			setInterval(show, 1000 * 60 * 60);
		};

		function show() {
			getData(function (result) {
				addHTML(result);
			});
		}

		function getKRTime() {
			var currTime = new Date();
			var utcTime =
				currTime.getTime() + currTime.getTimezoneOffset() * 60 * 1000;
			var KR_TIME_DIFF = 9 * 60 * 60 * 1000;
			var KRTime = new Date(utcTime + KR_TIME_DIFF);
			return KRTime;
		}

		function getCurrentTime() {
			var html = `<div id="update">Í∞±Ïã†: ${getKRTime().toString()}</div>`;
			var template = document.createElement('template');
			template.innerHTML = html.trim();
			return template.content.firstChild;
		}

		function addHTML(data) {
			var containers = document.getElementsByClassName('cards')[0];
			containers.textContent = '';
			for (var index in data) {
				var value = data[index];
				var html = makeHTML(value);
				containers.appendChild(html);
			}
			var currentTime = getCurrentTime();
			var app = document.getElementsByClassName('app')[0];
			app.appendChild(currentTime);
		}

		function makeHTML(value) {
			var html = `
        <div class="container">
					<div class="flex center neu text-small mono card-title bg-light">${value['date']}</div>
					<div class="neu card-body bg-dark">
						<div class="empty-box"></div>
						<div class="flex center text-weather weather">${value['weather']}</div>
						<div class="flex number-wrapper">
							<div class="flex center text-small mono number temp">üå°Ô∏è ${value['temp']}‚ÑÉ</div>
							<div class="flex center text-small mono number rain">üíß ${value['rain']}%</div>
						</div>
					</div>
        </div>`;
			var template = document.createElement('template');
			template.innerHTML = html.trim();

			return template.content.firstChild;
		}

		function parseDatetime(datetimeString) {
			var reg = /(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/;
			var dateArray = reg.exec(datetimeString);
			var datetime = new Date(
				+dateArray[1],
				+dateArray[2] - 1, // Careful, month starts at 0!
				+dateArray[3],
				+dateArray[4],
				+dateArray[5],
				+dateArray[6]
			);

			var date = datetime.getDate();
			var today = new Date().getDate();
			var isToday = 'Ïò§Îäò';
			if (date === today + 1) {
				isToday = 'ÎÇ¥Ïùº';
			}

			var hours = datetime.getHours();

			return `${isToday} ${hours}Ïãú`;
		}

		function getData(callback) {
			var xhr = new XMLHttpRequest();
			xhr.open('POST', url);
			xhr.setRequestHeader('Content-Type', 'application/json');

			xhr.onload = function () {
				callback(JSON.parse(xhr.responseText));
			};
			xhr.onerror = function () {
				console.error('Data fetch error');
			};

			xhr.send();
		}
	</script>
</html>
